<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product â€“ Bâ€™s Beauty Blossom</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* minimal helpers in case theme doesn't already include these */
    .out-of-stock .desc,
    .out-of-stock #product-image { opacity: .6; }
    .soldout-tag{
      position:absolute;left:10px;top:10px;
      background:#ef4444;color:#fff;font-weight:700;
      padding:6px 10px;border-radius:999px;font-size:.9rem
    }
    .btn[disabled], .btn[aria-disabled="true"]{
      opacity:.6; cursor:not-allowed; pointer-events:none;
    }
  </style>
</head>
<body>
<header>
  <nav class="navbar">
    <div class="logo"><a href="index.html"><span class="logo-mark">Bâ€™s</span> Beauty Blossom</a></div>
    <ul class="nav-links">
      <li class="nav-close" aria-label="Close menu">&times;</li>
      <li><a href="index.html">Home</a></li>
      <li><a href="perfume.html">Perfume</a></li>
      <li><a href="body.html">Body</a></li>
      <li><a href="skincare.html">Skincare</a></li>
      <li><a href="cosmetics.html">Cosmetics</a></li>
      <li><a href="jewellery.html">Jewellery</a></li>
      <li><a href="gift.html">Gift</a></li>
      <li><a href="cart.html">ðŸ›’ Cart (<span id="cart-count">0</span>)</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
    <div class="hamburger" aria-label="menu" aria-expanded="false">&#9776;</div>
  </nav>
  <div id="nav-overlay"></div>
</header>

<main class="section" id="product-main">
  <div class="product-detail" id="product-detail">
    <div class="product-media">
      <div style="position:relative">
        <img id="product-image" src="https://via.placeholder.com/800x800?text=Product" alt="Product image">
        <!-- out-of-stock badge will be injected here when needed -->
        <div id="oos-badge-slot"></div>
      </div>
      <div id="product-thumbs" class="thumbs"></div>
    </div>

    <div class="product-info">
      <h1 id="product-name">Product name</h1>
      <div id="product-brand" class="muted">Brand</div>
      <p id="product-desc" class="desc">Description</p>

      <label for="size">Choose size</label>
      <select id="size"></select>

      <div class="price-qty">
        <div class="price" id="price">Rs0</div>
        <div class="qty">
          <button id="qty-minus" type="button" aria-label="decrease quantity">â€“</button>
          <input id="qty" type="number" value="1" min="1">
          <button id="qty-plus" type="button" aria-label="increase quantity">+</button>
        </div>
      </div>

      <button id="add-to-cart" class="btn">Add to Cart</button>
    </div>
  </div>
</main>

<footer class="site-footer">
  <p>Â© 2025 Bâ€™s Beauty Blossom â€¢ All rights reserved</p>
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<!-- Load product from Firestore and render -->
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const fmt = (n)=>"Rs" + (Number(n||0).toFixed(0));

  function isOutOfStock(p){
    if (String(p.stockStatus||"").toLowerCase() === "out") return true;
    if (!isNaN(Number(p.stock))) return Number(p.stock) <= 0;
    return false;
  }

  function setPriceFromSelect(sel, priceEl){
    const opt = sel.options[sel.selectedIndex];
    const price = Number(opt?.dataset?.price || 0);
    priceEl.textContent = fmt(price);
  }

  function applyOOSUI(out){
    const addBtn = $("add-to-cart");
    const detail = $("product-detail");
    const qtyInput = $("qty");
    const minus = $("qty-minus");
    const plus  = $("qty-plus");
    const badgeSlot = $("oos-badge-slot");

    if (out){
      addBtn.textContent = "Out of Stock";
      addBtn.setAttribute("disabled","disabled");
      addBtn.setAttribute("aria-disabled","true");
      detail.classList.add("out-of-stock");

      minus.setAttribute("disabled","disabled");
      plus.setAttribute("disabled","disabled");
      qtyInput.setAttribute("disabled","disabled");

      badgeSlot.innerHTML = `<span class="soldout-tag">Out of Stock</span>`;
    }else{
      addBtn.textContent = "Add to Cart";
      addBtn.removeAttribute("disabled");
      addBtn.removeAttribute("aria-disabled");
      detail.classList.remove("out-of-stock");

      minus.removeAttribute("disabled");
      plus.removeAttribute("disabled");
      qtyInput.removeAttribute("disabled");

      badgeSlot.innerHTML = "";
    }
  }

  function wireThumbs(thumbsWrap, bigImg){
    thumbsWrap.addEventListener("click",(e)=>{
      const t = e.target.closest("img[data-src]");
      if(!t) return;
      const src = t.getAttribute("data-src");
      bigImg.src = src;
      thumbsWrap.querySelectorAll("img").forEach(img=>img.classList.remove("active"));
      t.classList.add("active");
    });
  }

  function wireQty(){
    const minus = $("qty-minus");
    const plus  = $("qty-plus");
    const input = $("qty");
    minus.addEventListener("click", ()=>{
      const n = Math.max(1, Number(input.value||1)-1);
      input.value = n;
    });
    plus.addEventListener("click", ()=>{
      const n = Math.max(1, Number(input.value||1)+1);
      input.value = n;
    });
    input.addEventListener("input", ()=>{
      const n = Math.max(1, Number(input.value||1));
      input.value = n;
    });
  }

  async function load(){
    if (!window.db) { console.error('Firestore not ready'); return; }
    const params = new URLSearchParams(location.search);
    const id = params.get('id');
    if (!id) { $("product-main").innerHTML = '<p>Product not found</p>'; return; }

    try {
      const doc = await db.collection('products').doc(id).get();
      if (!doc.exists) { $("product-main").innerHTML = '<p>Product not found</p>'; return; }
      const p = doc.data() || {};

      // Fill UI
      const big   = $("product-image");
      const thumbs= $("product-thumbs");
      const nameEl= $("product-name");
      const brandEl=$("product-brand");
      const descEl= $("product-desc");
      const sizeSel=$("size");
      const priceEl=$("price");

      document.title = (p.name ? p.name + " â€“ " : "") + "Bâ€™s Beauty Blossom";

      nameEl.textContent = p.name || '';
      brandEl.textContent= p.brand || '';
      descEl.textContent = p.description || '';

      const images = (Array.isArray(p.images) && p.images.length ? p.images : (p.imageURL?[p.imageURL]:[]));
      if (images.length) {
        big.src = images[0];
        thumbs.innerHTML = images.map((src,i)=>`
          <img class="${i===0?'active':''}" data-src="${src}" src="${src}" alt="thumb ${i+1}">
        `).join('');
        wireThumbs(thumbs, big);
      } else {
        thumbs.innerHTML = '';
      }

      // Sizes + initial price
      const sizes = Array.isArray(p.sizes) ? p.sizes : [];
      if (sizes.length) {
        sizeSel.innerHTML = sizes.map(s => {
          const pr = Number(s?.price||0);
          const lbl = String(s?.label||"");
          return `<option data-price="${pr}" value="${lbl}">${lbl} - Rs${pr}</option>`;
        }).join('');
      } else {
        const base = Number(p.basePrice || 0);
        sizeSel.innerHTML = `<option data-price="${base}" value="">Rs${base}</option>`;
      }
      setPriceFromSelect(sizeSel, priceEl);
      sizeSel.addEventListener("change", ()=>setPriceFromSelect(sizeSel, priceEl));

      // OOS handling
      const out = isOutOfStock(p) || !p.active;
      applyOOSUI(out);

      // Qty controls
      wireQty();

      // If you handle add-to-cart here, keep a guard:
      const addBtn = $("add-to-cart");
      addBtn.addEventListener("click", (e)=>{
        if (addBtn.hasAttribute("disabled")) {
          e.preventDefault();
          return;
        }
        // product-detail.js likely handles cart logic;
        // this guard ensures no add happens when disabled.
      });

    } catch (e) {
      console.error('Load product error:', e);
      $("product-main").innerHTML = '<p>Error loading product.</p>';
    }
  }

  load();
})();
</script>

<!-- Product interactions + navbar -->
<script src="product-detail.js"></script>
<script src="script.js"></script>
</body>
</html>
