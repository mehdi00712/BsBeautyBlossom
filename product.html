<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product â€“ Bâ€™s Beauty Blossom</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    .out-of-stock .desc,
    .out-of-stock #product-image { opacity: .6; }
    .soldout-tag{
      position:absolute;left:10px;top:10px;
      background:#ef4444;color:#fff;font-weight:700;
      padding:6px 10px;border-radius:999px;font-size:.9rem
    }
    .btn[disabled], .btn[aria-disabled="true"]{
      opacity:.6; cursor:not-allowed; pointer-events:none;
    }

    /* âœ… Better Product Page Layout (mobile friendly, premium look) */
    .product-detail{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:22px;
      align-items:start;
    }
    @media (max-width: 900px){
      .product-detail{ grid-template-columns: 1fr; }
    }

    /* âœ… FIX: stable image frame so you DON'T get huge empty white box */
    .media-frame{
      position:relative;
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      box-shadow:var(--shadow);
      overflow:hidden;

      height:360px;                 /* stable height */
      display:flex;
      align-items:center;
      justify-content:center;
    }
    @media (max-width:600px){
      .media-frame{ height:300px; }
    }

    /* Image fills frame */
    .product-media img#product-image{
      width:100% !important;
      height:100% !important;
      object-fit:contain !important;
      background:transparent !important;
      border:none !important;
      border-radius:12px;
      padding:0 !important;
      max-height:none !important;
    }

    /* âœ… thumbs slider with arrows (overlay) */
    .thumbs-wrap{
      position:relative;
      margin-top:10px;
    }

    .thumbs{
      display:flex;
      flex-wrap:nowrap;              /* IMPORTANT: allow horizontal scroll */
      gap:10px;
      overflow:auto;
      scroll-behavior:smooth;
      -webkit-overflow-scrolling:touch;

      padding:8px 46px;              /* space for overlay arrows */
      scrollbar-width:none;
    }
    .thumbs::-webkit-scrollbar{display:none}

    .thumbs img{
      width:74px;
      height:74px;
      object-fit:cover;
      border-radius:12px;
      border:2px solid transparent;
      background:#fff;
      cursor:pointer;
      flex:0 0 auto;
    }
    .thumbs img.active{
      border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(199,162,106,.18);
    }

    .thumb-nav{
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:38px;
      height:38px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:#573d21;
      font-size:22px;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:var(--shadow);
      z-index:50;                    /* clickable above thumbs */
      pointer-events:auto;
    }
    .thumb-nav.prev{ left:6px; }
    .thumb-nav.next{ right:6px; }

    .thumb-nav:hover{
      box-shadow:0 0 12px rgba(199,162,106,.35);
    }
    .thumb-nav:disabled{
      opacity:.4;
      cursor:not-allowed;
      box-shadow:none;
    }
    @media (max-width:600px){
      .thumb-nav{ width:34px; height:34px; border-radius:10px; }
    }

    /* info */
    .product-info{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
      box-shadow:var(--shadow);
    }
    .product-info h1{ margin-bottom:6px; }
    .desc{ margin:12px 0 14px; }

    /* price + qty row */
    .price-qty{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
      margin:14px 0;
      flex-wrap:wrap;
    }
    .price{
      font-size:1.35rem;
      font-weight:800;
      color:var(--brand);
    }

    /* qty controls */
    .qty{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .qty button{
      width:42px;
      height:42px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:20px;
      line-height:1;
    }
    .qty input{
      width:78px;
      text-align:center;
      font-weight:800;
      border-radius:12px;
    }

    /* add button full width */
    #add-to-cart{
      width:100%;
      margin-top:8px;
    }
  </style>
</head>
<body>

<header>
  <nav class="navbar">
    <div class="logo"><a href="index.html"><span class="logo-mark">Bâ€™s</span> Beauty Blossom</a></div>
    <ul class="nav-links">
      <li class="nav-close" aria-label="Close menu">&times;</li>
      <li><a href="index.html">Home</a></li>
      <li><a href="perfume.html">Perfume</a></li>
      <li><a href="body.html">Body</a></li>
      <li><a href="skincare.html">Skincare</a></li>
      <li><a href="cosmetics.html">Cosmetics</a></li>
      <li><a href="jewellery.html">Jewellery</a></li>
      <li><a href="gift.html">Gift</a></li>
      <li><a href="cart.html">ðŸ›’ Cart (<span id="cart-count">0</span>)</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
    <div class="hamburger" aria-label="menu" aria-expanded="false">&#9776;</div>
  </nav>
</header>

<!-- âœ… overlay should be OUTSIDE header (fix "film" on menu) -->
<div id="navOverlay" class="nav-overlay"></div>

<main class="section" id="product-main">
  <div class="product-detail" id="product-detail">
    <div class="product-media">

      <!-- âœ… FIX: use a real frame -->
      <div class="media-frame" style="position:relative">
        <img id="product-image" src="https://via.placeholder.com/800x800?text=Product" alt="Product image">
        <div id="oos-badge-slot"></div>
      </div>

      <!-- âœ… thumbs with arrows (buttons are overlay + clickable) -->
      <div class="thumbs-wrap">
        <button type="button" class="thumb-nav prev" id="thumbPrev" aria-label="Scroll thumbnails left">â€¹</button>
        <div id="product-thumbs" class="thumbs"></div>
        <button type="button" class="thumb-nav next" id="thumbNext" aria-label="Scroll thumbnails right">â€º</button>
      </div>
    </div>

    <div class="product-info">
      <h1 id="product-name">Product name</h1>
      <div id="product-brand" class="muted">Brand</div>
      <p id="product-desc" class="desc">Description</p>

      <label for="size">Choose size</label>
      <select id="size"></select>

      <div class="price-qty">
        <div class="price" id="price">Rs0</div>
        <div class="qty">
          <button id="qty-minus" type="button" aria-label="decrease quantity">â€“</button>
          <input id="qty" type="number" value="1" min="1">
          <button id="qty-plus" type="button" aria-label="increase quantity">+</button>
        </div>
      </div>

      <button id="add-to-cart" class="btn">Add to Cart</button>
    </div>
  </div>
</main>

<footer class="site-footer">
  <p>Â© 2025 Bâ€™s Beauty Blossom â€¢ All rights reserved</p>
</footer>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<!-- ============================================================
     PRODUCT LOADER WITH FULL DISCOUNT SUPPORT
=============================================================== -->
<script>
(function(){
  const $ = (id)=>document.getElementById(id);
  const fmt = (n)=>"Rs" + Number(n||0).toFixed(0);

  function isOutOfStock(p){
    if (String(p.stockStatus||"").toLowerCase() === "out") return true;
    if (!isNaN(Number(p.stock))) return Number(p.stock) <= 0;
    return false;
  }

  function applyOOSUI(out){
    const addBtn  = $("add-to-cart");
    const detail  = $("product-detail");
    const qty     = $("qty");
    const minus   = $("qty-minus");
    const plus    = $("qty-plus");
    const badgeSlot = $("oos-badge-slot");

    if (out){
      addBtn.textContent = "Out of Stock";
      addBtn.setAttribute("disabled","disabled");

      minus.setAttribute("disabled","disabled");
      plus.setAttribute("disabled","disabled");
      qty.setAttribute("disabled","disabled");

      detail.classList.add("out-of-stock");
      badgeSlot.innerHTML = `<span class="soldout-tag">Out of Stock</span>`;
    } else {
      addBtn.textContent = "Add to Cart";
      addBtn.removeAttribute("disabled");

      minus.removeAttribute("disabled");
      plus.removeAttribute("disabled");
      qty.removeAttribute("disabled");

      detail.classList.remove("out-of-stock");
      badgeSlot.innerHTML = "";
    }
  }

  function wireQty(){
    const input = $("qty");
    const minus = $("qty-minus");
    const plus  = $("qty-plus");

    if (!input || !minus || !plus) return;

    // âœ… prevent double-binding (product-detail.js also binds)
    if (minus.dataset.bound === "1" || plus.dataset.bound === "1") return;

    if (!minus.dataset.bound) {
      minus.dataset.bound = "1";
      minus.addEventListener("click", ()=>{
        input.value = Math.max(1, Number(input.value || 1) - 1);
      });
    }

    if (!plus.dataset.bound) {
      plus.dataset.bound = "1";
      plus.addEventListener("click", ()=>{
        input.value = Math.max(1, Number(input.value || 1) + 1);
      });
    }
  }

  /* âœ… arrows for thumbnail scroller */
  function bindThumbArrows(){
    const thumbs = $("product-thumbs");
    const prev = $("thumbPrev");
    const next = $("thumbNext");
    if (!thumbs || !prev || !next) return;

    if (thumbs.dataset.arrowBound === "1") return;
    thumbs.dataset.arrowBound = "1";

    const step = () => Math.max(220, Math.floor(thumbs.clientWidth * 0.7));

    function update(){
      const max = thumbs.scrollWidth - thumbs.clientWidth - 2;
      prev.disabled = thumbs.scrollLeft <= 2;
      next.disabled = thumbs.scrollLeft >= max;
    }

    prev.addEventListener("click", (e)=>{
      e.preventDefault();
      thumbs.scrollBy({ left: -step(), behavior: "smooth" });
      setTimeout(update, 250);
    });

    next.addEventListener("click", (e)=>{
      e.preventDefault();
      thumbs.scrollBy({ left: step(), behavior: "smooth" });
      setTimeout(update, 250);
    });

    thumbs.addEventListener("scroll", update);
    window.addEventListener("resize", update);

    // initial state
    setTimeout(update, 200);
  }

  async function load(){
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
    if (!id) return;

    const doc = await db.collection("products").doc(id).get();
    if (!doc.exists) return;

    const p = doc.data();

    // BASIC INFO
    $("product-name").textContent  = p.name || "";
    $("product-brand").textContent = p.brand || "";
    $("product-desc").textContent  = p.description || "";

    // IMAGES
    const allImages = Array.isArray(p.images) && p.images.length
      ? p.images
      : (p.imageURL ? [p.imageURL] : []);

    const big = $("product-image");
    const thumbs = $("product-thumbs");

    if (allImages.length){
      big.src = allImages[0];
      thumbs.innerHTML = allImages.map((src,i)=>`
        <img data-src="${src}" src="${src}" class="${i===0?'active':''}">
      `).join("");

      // âœ… prevent double-binding if load() runs again
      if (!thumbs.dataset.bound){
        thumbs.dataset.bound = "1";
        thumbs.addEventListener("click",(e)=>{
          const t = e.target.closest("img[data-src]");
          if (!t) return;
          big.src = t.dataset.src;
          thumbs.querySelectorAll("img").forEach(img=>img.classList.remove("active"));
          t.classList.add("active");
        });
      }

      // âœ… bind arrow buttons AFTER thumbs exist
      bindThumbArrows();
    }

    // DISCOUNT LOGIC
    const hasDiscount = p.discountPrice && Number(p.discountPrice) > 0;
    const discountVal = hasDiscount ? Number(p.discountPrice) : 0;

    const sizes = Array.isArray(p.sizes) ? p.sizes : [];

    const finalSizes = sizes.map(s => {
      const base = Number(s.price || 0);
      const final = hasDiscount ? Math.min(base, discountVal) : base;
      return { label: s.label, basePrice: base, finalPrice: final };
    });

    let noSizeFinalPrice = null;
    if (!sizes.length){
      const base = Number(p.basePrice || 0);
      noSizeFinalPrice = hasDiscount ? Math.min(base, discountVal) : base;
    }

    // SIZE DROPDOWN
    const sizeSel = $("size");

    if (finalSizes.length){
      sizeSel.innerHTML = finalSizes.map(s=>`
        <option data-price="${s.finalPrice}" data-base="${s.basePrice}" value="${s.label}">
          ${s.label} - Rs${s.finalPrice}
        </option>
      `).join("");
    } else {
      sizeSel.innerHTML = `
        <option data-price="${noSizeFinalPrice}" data-base="${p.basePrice}">
          Rs${noSizeFinalPrice}
        </option>
      `;
    }

    // PRICE HANDLE
    const priceEl = $("price");
    function updatePrice(){
      const opt = sizeSel.selectedOptions[0];
      priceEl.textContent = fmt(opt.dataset.price);
    }
    if (!sizeSel.dataset.bound){
      sizeSel.dataset.bound = "1";
      sizeSel.addEventListener("change", updatePrice);
    }
    updatePrice();

    // SEND DATA TO product-detail.js
    window.__productData = {
      id,
      name: p.name,
      brand: p.brand,
      description: p.description,
      discountPrice: hasDiscount ? discountVal : 0,
      sizes: finalSizes.length ? finalSizes.map(s=>({
        label: s.label,
        price: s.finalPrice
      })) : [],
      basePrice: p.basePrice || 0
    };

    // OOS
    applyOOSUI(isOutOfStock(p) || !p.active);

    // âœ… only binds if product-detail.js didn't already
    wireQty();
  }

  load();
})();
</script>

<!-- Extra scripts -->
<script src="product-detail.js"></script>
<script src="script.js"></script>

</body>
</html>
