<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Checkout - B's Beauty Blossom</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase Realtime DB for orders -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBSA9iP3kjdYZM0eXt_KOXAgPT_z74cGJ8",
  authDomain: "beauty-blossom-5247d.firebaseapp.com",
  databaseURL: "https://beauty-blossom-5247d-default-rtdb.firebaseio.com",
  projectId: "beauty-blossom-5247d",
  storageBucket: "beauty-blossom-5247d.firebasestorage.app",
  messagingSenderId: "916163644879",
  appId: "1:916163644879:web:2bf1f40e21b1abd73816ba",
  measurementId: "G-1QD13LXLRM"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
</script>

<style>
.cart-list { display: grid; gap: 10px; }
.cart-row {
  display: grid; grid-template-columns: 70px 1fr auto; gap: 10px; align-items: center;
  padding: 10px; border: 1px solid #222; border-radius: 12px; background: var(--card,#15151a);
}
.cart-img { width: 70px; height: 70px; object-fit: cover; border-radius: 10px; border: 1px solid #23232a; background: #0d0d12; }
.cart-row .meta { line-height: 1.3 }
.cart-row .meta .name { font-weight: 600 }
.cart-row .meta .muted { color: var(--muted,#a3a3a3); font-size: 13px }
.cart-row .tot { white-space: nowrap; text-align: right }
@media (max-width:560px){
  .cart-row { grid-template-columns: 60px 1fr; }
  .cart-row .tot { grid-column: 2; justify-self: end; }
}
</style>
</head>
<body>
<header>
<nav class="navbar">
  <div class="logo"><a href="index.html"><img src="1.jpg" alt="Logo" width="80"></a></div>
  <ul class="nav-links">
    <li><a href="index.html">Home</a></li>
    <li><a href="perfume.html">Perfume</a></li>
    <li><a href="body.html">Body</a></li>
    <li><a href="skincare.html">Skincare</a></li>
    <li><a href="cosmetics.html">Cosmetics</a></li>
    <li><a href="jewellery.html">Jewellery</a></li>
    <li><a href="gift.html">Gift</a></li>
    <li><a href="cart.html" class="active">ðŸ›’ Cart (<span id="cart-count">0</span>)</a></li>
    <li><a href="admin.html">Admin</a></li>
  </ul>
  <div class="hamburger">&#9776;</div>
</nav>
</header>

<section class="cart">
  <h1>Checkout</h1>
  <div id="cart-items" class="card cart-list"></div>
  <p id="total" style="font-size:18px;margin-top:10px"></p>

  <h2 style="margin-top:24px">Delivery Method</h2>
  <form id="delivery-form" class="card" style="padding:16px">
    <label><input type="radio" name="delivery" value="Pick Up" required> Pick Up (Free)</label><br>
    <label><input type="radio" name="delivery" value="Postage"> Postage (+Rs125)</label><br>
    <label><input type="radio" name="delivery" value="Delivery"> Delivery (+Rs150)</label><br><br>

    <div id="customer-info" style="display:none;">
      <h2>Customer Details</h2>
      <input type="text" id="name" placeholder="Full Name" required><br>
      <input type="email" id="email" placeholder="Email" required><br>
      <input type="tel" id="phone" placeholder="Phone Number" required><br>
      <div id="address-section" style="display:none;">
        <input type="text" id="address" placeholder="Delivery Address"><br>
      </div>

      <h2>Payment Method</h2>
      <label><input type="radio" name="payment" value="Juice" required> Juice Payment (via account transfer)</label><br>
      <label><input type="radio" name="payment" value="Pick Up Payment"> Payment at Pick Up</label><br><br>

      <div id="juice-section" class="card" style="display:none; text-align:center; padding:16px">
        <h3>Juice Payment Instructions</h3>
        <p>1. Open your Juice app</p>
        <p>2. Transfer the total amount to the following account:</p>
        <p><strong>Account Number: 000450702685</strong></p>
        <p>3. Send your payment receipt/screenshot to <strong>+230 58195560</strong></p>
        <p>4. Press "Confirm Order" below once payment is completed</p>
      </div>

      <button type="submit" class="btn" style="margin-top:10px">Confirm Order</button>
    </div>
  </form>
</section>

<script>
// Navbar toggle
const hamburger = document.querySelector(".hamburger");
const navLinks = document.querySelector(".nav-links");
if(hamburger) hamburger.addEventListener("click", ()=>navLinks.classList.toggle("show"));

// Canonical cart key only
const CART_KEY = 'bbb_cart_v2';

function readCart(){
  const arr = JSON.parse(localStorage.getItem(CART_KEY) || '[]');
  if (!Array.isArray(arr)) return [];
  // normalize fields we use
  return arr.map(i => ({
    name: i.name,
    unitPrice: Number(i.unitPrice ?? i.price ?? 0), // <- always resolve to unitPrice
    qty: Number(i.qty ?? i.quantity ?? 1),
    imageURL: i.imageURL || i.image || ''
  }));
}
function writeCart(items){
  localStorage.setItem(CART_KEY, JSON.stringify(items));
  localStorage.removeItem('cart'); // drop legacy
}
function clearCart(){
  localStorage.removeItem(CART_KEY);
  localStorage.removeItem('cart');
}
function cartCount(items){ return items.reduce((n,i)=>n+(i.qty||0),0); }

let baseTotal = 0, extraCharge = 0;

function loadCart() {
  const cart = readCart();
  const container = document.getElementById("cart-items");
  container.innerHTML = "";
  baseTotal = 0;

  const badge = document.getElementById("cart-count");
  if(!cart.length){
    container.innerHTML = "<p>Your cart is empty.</p>";
    document.getElementById("total").textContent = "";
    if (badge) badge.textContent = 0;
    return;
  }

  cart.forEach((item, index)=>{
    const price = Number(item.unitPrice)||0;
    const qty = Number(item.qty)||0;
    const itemTotal = price * qty;
    baseTotal += itemTotal;

    const row = document.createElement('div');
    row.className = 'cart-row';
    row.innerHTML = `
      <img class="cart-img" src="${item.imageURL || 'https://via.placeholder.com/600x600?text=No+Image'}" alt="">
      <div class="meta">
        <div class="name">${item.name}</div>
        <div class="muted">Rs${price} Ã— ${qty}</div>
      </div>
      <div class="tot">
        <div><strong>Rs${itemTotal}</strong></div>
        <button class="btn danger" data-i="${index}" style="margin-top:6px">Remove</button>
      </div>
    `;
    container.appendChild(row);

    row.querySelector('button').addEventListener('click', ()=>{
      const now = readCart();
      now.splice(index,1);
      writeCart(now);
      loadCart();
      if (badge) badge.textContent = cartCount(readCart());
    });
  });

  updateTotal();
  if (badge) badge.textContent = cartCount(cart);
}
function updateTotal(){
  document.getElementById("total").textContent = "Total: Rs" + (baseTotal + extraCharge);
}
loadCart();

// Delivery & Payment logic
const deliveryRadios = document.querySelectorAll('input[name="delivery"]');
const paymentRadios = document.querySelectorAll('input[name="payment"]');
const customerInfo = document.getElementById("customer-info");
const addressSection = document.getElementById("address-section");
const juiceSection = document.getElementById("juice-section");

deliveryRadios.forEach(radio=>{
  radio.addEventListener("change",()=>{
    customerInfo.style.display="block";

    if(radio.value === "Postage"){ 
      extraCharge = 125;
      addressSection.style.display="block";
    } else if(radio.value === "Delivery"){ 
      extraCharge = 150;
      addressSection.style.display="block";
    } else { 
      extraCharge = 0;
      addressSection.style.display="none";
    }
    updateTotal();

    paymentRadios.forEach(pay=>{
      if(radio.value === "Postage" || radio.value === "Delivery"){
        if(pay.value === "Pick Up Payment") pay.disabled = true;
        if(pay.value === "Juice") pay.checked = true;
      } else {
        pay.disabled = false;
      }
    });
    const current = document.querySelector('input[name="payment"]:checked');
    juiceSection.style.display = current && current.value === "Juice" ? "block" : "none";
  });
});

paymentRadios.forEach(radio=>{
  radio.addEventListener("change",()=>{
    juiceSection.style.display = radio.value === "Juice" ? "block" : "none";
  });
});

// Validate
function validateForm(){
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const delivery = document.querySelector('input[name="delivery"]:checked').value;

  if(!/^5\d{7}$/.test(phone)){
    alert("Phone number must start with 5 and be exactly 8 digits.");
    return false;
  }
  if(!email.includes("@")){
    alert("Please enter a valid email address.");
    return false;
  }
  if(delivery === "Postage" || delivery === "Delivery"){
    const payment = document.querySelector('input[name="payment"]:checked').value;
    if(payment !== "Juice"){
      alert("For Postage and Delivery, payment must be made via Juice.");
      return false;
    }
  }
  return true;
}

// Submit
document.getElementById("delivery-form").addEventListener("submit", async (e)=>{
  e.preventDefault();

  if(!validateForm()) return;

  const cart = readCart();
  if(cart.length===0){ alert("Cart is empty."); return; }

  // guard zero-priced lines
  if (cart.some(i => !i.unitPrice || i.unitPrice <= 0 || !i.qty || i.qty <= 0)) {
    alert('One or more items have invalid price/quantity. Please remove and re-add.');
    return;
  }

  const selectedDelivery = document.querySelector('input[name="delivery"]:checked').value;
  const subtotal = cart.reduce((n,i)=> n + Number(i.unitPrice||0) * Number(i.qty||0), 0);
  const shipping = (selectedDelivery==="Postage") ? 125 : (selectedDelivery==="Delivery") ? 150 : 0;
  const total = subtotal + shipping;

  const order = {
    items: cart,               // includes imageURL, name, unitPrice, qty
    delivery: selectedDelivery === "Delivery" ? "Delivery" : null,
    postage: selectedDelivery === "Postage" ? "Postage" : null,
    pickup: selectedDelivery === "Pick Up" ? "Pick Up" : null,
    payment: document.querySelector('input[name="payment"]:checked').value,
    name: document.getElementById("name").value.trim(),
    email: document.getElementById("email").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    address: document.getElementById("address").value.trim() || "N/A",
    subtotal, shipping, total,
    timestamp: new Date().toISOString()
  };

  try{
    const newOrderRef = database.ref('orders').push();
    await newOrderRef.set(order);
    alert("Order confirmed! Thank you for shopping with B's Beauty Blossom.");
    clearCart();
    loadCart();
    const badge = document.getElementById("cart-count"); if (badge) badge.textContent = 0;
    window.location.href="index.html";
  }catch(err){
    alert("Error saving order: "+err);
  }
});
</script>
</body>
</html>
