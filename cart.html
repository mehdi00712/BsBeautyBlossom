<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Checkout - Bâ€™s Beauty Blossom</title>
<link rel="stylesheet" href="style.css">
<!-- Firebase RTDB only -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="firebase-config.js"></script>
</head>
<body>
<header>
  <nav class="navbar">
    <div class="logo"><a href="index.html"><span class="logo-mark">Bâ€™s</span> Beauty Blossom</a></div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="perfume.html">Perfume</a></li>
      <li><a href="body.html">Body</a></li>
      <li><a href="skincare.html">Skincare</a></li>
      <li><a href="cosmetics.html">Cosmetics</a></li>
      <li><a href="jewellery.html">Jewellery</a></li>
      <li><a href="gift.html">Gift</a></li>
      <li><a class="active" href="cart.html">ðŸ›’ Cart (<span id="cart-count">0</span>)</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
    <div class="hamburger" aria-label="menu" aria-expanded="false">&#9776;</div>
  </nav><div id="nav-overlay"></div>
</header>

<section class="section">
  <h1>Checkout</h1>

  <div id="cart-items" class="cart-list"></div>
  <div class="totals">
    <div class="totals-row"><span>Subtotal</span><span id="subtotal">Rs0</span></div>
    <div class="totals-row"><span>Shipping</span><span id="shipping">Rs0</span></div>
    <div class="totals-row"><strong>Total</strong><strong id="total">Rs0</strong></div>
  </div>

  <h2 style="margin-top:20px">Delivery Method</h2>
  <form id="checkout-form">
    <label><input type="radio" name="delivery" value="Pick Up" required> Pick Up (Free)</label><br>
    <label><input type="radio" name="delivery" value="Postage"> Postage (+Rs125)</label><br>
    <label><input type="radio" name="delivery" value="Delivery"> Delivery (+Rs150)</label><br><br>

    <div id="customer-info" class="card" style="display:none;margin-top:10px">
      <h3 style="font-family:'Playfair Display',serif;margin-bottom:10px">Customer Details</h3>
      <div class="row row-2">
        <div><input type="text" id="name" placeholder="Full Name" required></div>
        <div><input type="email" id="email" placeholder="Email" required></div>
      </div>
      <div class="row row-2">
        <div><input type="tel" id="phone" placeholder="Phone (8 digits, starts with 5)" required></div>
        <div id="address-wrap" style="display:none"><input type="text" id="address" placeholder="Delivery Address"></div>
      </div>

      <h3 style="font-family:'Playfair Display',serif;margin:10px 0 8px">Payment</h3>
      <label><input type="radio" name="payment" value="Juice" required> Juice Payment</label><br>
      <label><input type="radio" name="payment" value="Pick Up Payment"> Pay at Pick Up</label><br>

      <div id="juice-info" class="card" style="display:none;margin-top:10px;text-align:center">
        <h4>Juice Payment Instructions</h4>
        <p>1. Open your Juice app</p>
        <p>2. Transfer the total amount to:</p>
        <p><strong>Account Number: 000450702685</strong></p>
        <p>3. Send your payment receipt to <strong>+230 58195560</strong></p>
      </div>

      <button type="submit" class="btn btn-primary" style="margin-top:10px">Confirm Order</button>
    </div>
  </form>
</section>

<footer class="site-footer"><p>Â© 2025 Bâ€™s Beauty Blossom â€¢ All rights reserved</p></footer>

<script src="script.js"></script>
<script>
(function(){
  const list = document.getElementById('cart-items');
  const subtotalEl = document.getElementById('subtotal');
  const shippingEl = document.getElementById('shipping');
  const totalEl = document.getElementById('total');
  const form = document.getElementById('checkout-form');
  const customerInfo = document.getElementById('customer-info');
  const addressWrap = document.getElementById('address-wrap');
  const juiceInfo = document.getElementById('juice-info');

  let cart=[], baseSubtotal=0, shipping=0;

  function money(n){ return 'Rs'+Number(n||0).toFixed(0); }
  function loadCart(){
    cart = JSON.parse(localStorage.getItem('cart')||'[]');
    list.innerHTML='';
    baseSubtotal = 0;
    if (!cart.length){ list.innerHTML='<p class="muted">Your cart is empty.</p>'; }
    cart.forEach((it,i)=>{
      const line = Number(it.price||0)*Number(it.qty||it.quantity||1);
      baseSubtotal += line;
      const row = document.createElement('div');
      row.className='cart-row';
      row.innerHTML = `
        <img class="cart-thumb" src="${it.imageURL||'https://via.placeholder.com/60'}" alt="">
        <div>
          <div class="cart-title">${it.name||''}</div>
          <div class="cart-meta">${money(it.price||0)} Ã— ${Number(it.qty||it.quantity||1)}</div>
        </div>
        <div class="cart-line">${money(line)}</div>
        <div class="cart-actions"><button class="btn danger" data-del="${i}">Remove</button></div>
      `;
      list.appendChild(row);
    });
    list.querySelectorAll('[data-del]').forEach(b=>b.addEventListener('click', ()=>{
      const idx=Number(b.getAttribute('data-del')); cart.splice(idx,1);
      localStorage.setItem('cart', JSON.stringify(cart)); loadCart(); window.updateCartCount?.();
    }));
    updateTotals();
  }
  function updateTotals(){ subtotalEl.textContent=money(baseSubtotal); shippingEl.textContent=money(shipping); totalEl.textContent=money(baseSubtotal+shipping); }
  loadCart(); window.updateCartCount?.();

  // Delivery changes
  form.querySelectorAll('input[name="delivery"]').forEach(r=>r.addEventListener('change',()=>{
    customerInfo.style.display='block';
    if (r.value==='Delivery'){ shipping=150; addressWrap.style.display='block'; }
    else if (r.value==='Postage'){ shipping=125; addressWrap.style.display='block'; }
    else { shipping=0; addressWrap.style.display='none'; }
    // force payment to Juice for shipping methods
    if (r.value!=='Pick Up'){ form.querySelector('input[value="Juice"]').checked = true; juiceInfo.style.display='block'; }
    else { juiceInfo.style.display = form.querySelector('input[name="payment"]:checked')?.value==='Juice'?'block':'none'; }
    updateTotals();
  }));
  form.querySelectorAll('input[name="payment"]').forEach(r=>r.addEventListener('change',()=>{ juiceInfo.style.display = r.value==='Juice'?'block':'none'; }));

  function validate(){
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const del = form.querySelector('input[name="delivery"]:checked').value;
    if (!/^5\d{7}$/.test(phone)){ alert('Phone must start with 5 and be 8 digits.'); return false; }
    if (!/@/.test(email)){ alert('Enter a valid email.'); return false; }
    if ((del==='Delivery'||del==='Postage') && form.querySelector('input[name="payment"]:checked').value!=='Juice'){ alert('For Delivery/Postage, payment must be Juice.'); return false; }
    return true;
  }

  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    if (!cart.length) return alert('Cart is empty.');
    if (!validate()) return;

    const del = form.querySelector('input[name="delivery"]:checked').value;
    const pay = form.querySelector('input[name="payment"]:checked').value;

    const order = {
      items: cart.map(it=>({name: it.name, quantity: Number(it.qty||it.quantity||1), price: Number(it.price||0), imageURL: it.imageURL||''})),
      delivery: del==='Delivery'?'Delivery':null,
      postage: del==='Postage'?'Postage':null,
      pickup: del==='Pick Up'?'Pick Up':null,
      payment: pay,
      name: document.getElementById('name').value.trim(),
      email: document.getElementById('email').value.trim(),
      phone: document.getElementById('phone').value.trim(),
      address: document.getElementById('address').value.trim() || 'N/A',
      subtotal: baseSubtotal,
      shipping: shipping,
      total: baseSubtotal+shipping,
      timestamp: new Date().toISOString()
    };

    try{
      await rtdb.ref('orders').push(order);
      alert('Order confirmed! Thank you.');
      localStorage.removeItem('cart'); window.updateCartCount?.();
      window.location.href='index.html';
    }catch(err){
      alert('Error saving order: '+(err.message||err));
    }
  });
})();
</script>
</body>
</html>
