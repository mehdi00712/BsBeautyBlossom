<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Checkout - B's Beauty Blossom</title>
<link rel="stylesheet" href="style.css">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="firebase-config.js"></script>
</head>
<body>
<header>
  <nav class="navbar">
    <div class="logo"><a href="index.html"><span class="logo-mark">Bâ€™s</span> Beauty Blossom</a></div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="perfume.html">Perfume</a></li>
      <li><a href="body.html">Body</a></li>
      <li><a href="skincare.html">Skincare</a></li>
      <li><a href="cosmetics.html">Cosmetics</a></li>
      <li><a href="jewellery.html">Jewellery</a></li>
      <li><a href="gift.html">Gift</a></li>
      <li><a href="cart.html" class="active">ðŸ›’ Cart (<span id="cart-count">0</span>)</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
    <div class="hamburger" aria-label="menu" aria-expanded="false">&#9776;</div>
  </nav>
  <div id="nav-overlay"></div>
</header>

<section class="section">
  <h1>Checkout</h1>

  <div id="cart-items" class="cart-list"></div>
  <div class="totals">
    <div class="totals-row"><span>Subtotal</span><span id="subtotal">Rs0</span></div>
    <div class="totals-row"><span>Shipping</span><span id="shipping">Rs0</span></div>
    <div class="totals-row"><strong>Total</strong><strong id="total">Rs0</strong></div>
  </div>

  <h2 style="margin-top:18px">Delivery Method</h2>
  <form id="delivery-form" class="card">
    <label><input type="radio" name="delivery" value="Pick Up" required> Pick Up (Free)</label><br>
    <label><input type="radio" name="delivery" value="Postage"> Postage (+Rs125)</label><br>
    <label><input type="radio" name="delivery" value="Delivery"> Delivery (+Rs150)</label><br><br>

    <div id="customer-info" style="display:none;">
      <h3>Customer Details</h3>
      <input type="text" id="name" placeholder="Full Name" required><br>
      <input type="email" id="email" placeholder="Email" required><br>
      <input type="tel" id="phone" placeholder="Phone Number" required><br>
      <div id="address-section" style="display:none;">
        <input type="text" id="address" placeholder="Delivery Address"><br>
      </div>

      <h3>Payment Method</h3>
      <label><input type="radio" name="payment" value="Juice" required> Juice Payment (account transfer)</label><br>
      <label><input type="radio" name="payment" value="Pick Up Payment"> Payment at Pick Up</label><br><br>

      <div id="juice-section" style="display:none;">
        <div class="card" style="text-align:center">
          <h3>Juice Payment Instructions</h3>
          <p>1. Open your Juice app</p>
          <p>2. Transfer the total amount to: <strong>Account Number: 000450702685</strong></p>
          <p>3. Send the receipt to <strong>+230 58195560</strong></p>
          <p>4. Press "Confirm Order" once payment is done</p>
        </div>
      </div>

      <button type="submit" class="btn btn-primary" style="margin-top:10px">Confirm Order</button>
    </div>
  </form>
</section>

<footer class="site-footer"><p>Â© 2025 Bâ€™s Beauty Blossom â€¢ All rights reserved</p></footer>

<script src="script.js"></script>
<script>
let baseTotal=0, extraCharge=0;

function money(n){ return 'Rs'+Number(n||0).toFixed(0); }

function loadCart(){
  const cart = JSON.parse(localStorage.getItem('cart')||'[]');
  const container = document.getElementById('cart-items');
  container.innerHTML = '';
  baseTotal = 0;

  if (!cart.length){
    container.innerHTML = '<p class="muted">Your cart is empty.</p>';
    updateTotals();
    return;
  }

  cart.forEach((item, idx)=>{
    const line = Number(item.price||0)*Number(item.qty||item.quantity||1);
    baseTotal += line;
    const row = document.createElement('div');
    row.className = 'cart-row';
    row.innerHTML = `
      <img class="cart-thumb" src="${item.imageURL||''}" alt="">
      <div>
        <div class="cart-title">${item.name||''}</div>
        <div class="cart-meta">${money(item.price)} each</div>
      </div>
      <div class="cart-actions">
        <button class="qty-btn" onclick="changeQty(${idx},-1)">â€“</button>
        <span class="qty-val">${Number(item.qty||item.quantity||1)}</span>
        <button class="qty-btn" onclick="changeQty(${idx},1)">+</button>
      </div>
      <div class="cart-line">${money(line)}</div>
    `;
    container.appendChild(row);
  });
  updateTotals();
  refreshCartBadge();
}
function updateTotals(){
  document.getElementById('subtotal').textContent = money(baseTotal);
  document.getElementById('shipping').textContent = money(extraCharge);
  document.getElementById('total').textContent = money(baseTotal+extraCharge);
}
function changeQty(index, delta){
  const cart = JSON.parse(localStorage.getItem('cart')||'[]');
  if (!cart[index]) return;
  const current = Number(cart[index].qty||cart[index].quantity||1);
  const next = Math.max(1, current + delta);
  cart[index].qty = next; delete cart[index].quantity;
  localStorage.setItem('cart', JSON.stringify(cart));
  loadCart();
}

const deliveryRadios = document.querySelectorAll('input[name="delivery"]');
const paymentRadios = document.querySelectorAll('input[name="payment"]');
const customerInfo = document.getElementById("customer-info");
const addressSection = document.getElementById("address-section");
const juiceSection = document.getElementById("juice-section");

deliveryRadios.forEach(r=>{
  r.addEventListener('change', ()=>{
    customerInfo.style.display='block';
    if (r.value==='Postage'){ extraCharge=125; addressSection.style.display='block'; }
    else if (r.value==='Delivery'){ extraCharge=150; addressSection.style.display='block'; }
    else { extraCharge=0; addressSection.style.display='none'; }

    paymentRadios.forEach(p=>{
      if (r.value!=='Pick Up' && p.value==='Pick Up Payment'){ p.disabled=true; p.checked=false; }
      else p.disabled=false;
    });
    const chosen = document.querySelector('input[name="payment"]:checked');
    juiceSection.style.display = (chosen && chosen.value==='Juice') ? 'block' : 'none';
    updateTotals();
  });
});
paymentRadios.forEach(p=>{
  p.addEventListener('change', ()=>{
    juiceSection.style.display = (p.value==='Juice') ? 'block' : 'none';
  });
});

function validateForm(){
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const delivery = document.querySelector('input[name="delivery"]:checked')?.value;
  if (!/^5\d{7}$/.test(phone)){ alert("Phone must start with 5 and be exactly 8 digits."); return false; }
  if (!email.includes("@")){ alert("Enter a valid email."); return false; }
  if (delivery && delivery!=='Pick Up'){
    const payment = document.querySelector('input[name="payment"]:checked')?.value;
    if (payment!=='Juice'){ alert("For Postage/Delivery, payment must be via Juice."); return false; }
  }
  return true;
}

document.getElementById("delivery-form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if (!validateForm()) return;
  const cart = JSON.parse(localStorage.getItem('cart')||'[]');
  if (!cart.length){ alert("Cart is empty."); return; }

  const selectedDelivery = document.querySelector('input[name="delivery"]:checked').value;
  const order = {
    items: cart.map(i=>({
      name: i.name, quantity: Number(i.qty||i.quantity||1)||1, price: Number(i.price||0)||0, imageURL: i.imageURL||''
    })),
    delivery: selectedDelivery === "Delivery" ? "Delivery" : null,
    postage: selectedDelivery === "Postage" ? "Postage" : null,
    pickup: selectedDelivery === "Pick Up" ? "Pick Up" : null,
    payment: document.querySelector('input[name="payment"]:checked').value,
    name: document.getElementById("name").value.trim(),
    email: document.getElementById("email").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    address: document.getElementById("address").value.trim() || "N/A",
    shipping: extraCharge,
    subtotal: baseTotal,
    total: baseTotal+extraCharge,
    timestamp: new Date().toISOString()
  };

  try{
    const ref = rtdb.ref('orders').push();
    await ref.set(order);
    alert("Order confirmed! Thank you for shopping with B's Beauty Blossom.");
    localStorage.removeItem("cart");
    loadCart();
    document.getElementById("cart-count").textContent = 0;
    location.href="index.html";
  }catch(err){
    alert("Error saving order: "+err.message);
  }
});

loadCart();
document.getElementById("cart-count").textContent =
  (JSON.parse(localStorage.getItem("cart")||"[]")).reduce((s,i)=>s+(Number(i.qty||i.quantity||1)||1),0);
</script>
</body>
</html>
