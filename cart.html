<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Checkout ‚Äì B‚Äôs Beauty Blossom</title>
  <link rel="stylesheet" href="style.css"/>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    .cart-list { max-width: 900px; margin: 20px auto; }
    .cart-item {
      display: grid;
      grid-template-columns: 70px 1fr auto;
      gap: 12px;
      align-items: center;
      padding: 12px;
      border: 1px solid #eee;
      border-radius: 10px;
      margin-bottom: 10px;
      background: #fff;
    }
    .cart-thumb { width: 70px; height: 70px; object-fit: cover; border-radius: 8px; border: 1px solid #eee; }
    .cart-line b { display:block; margin-bottom: 2px; }
    .qty-ctrl { display:flex; align-items:center; gap:6px; }
    .qty-ctrl input { width: 48px; text-align:center; padding:6px 8px; border:1px solid #ddd; border-radius:8px; }
    .qty-ctrl button { padding:6px 10px; border:1px solid #ddd; background:#f7f7f7; border-radius:8px; cursor:pointer; }
    .line-total { font-weight:600; min-width: 90px; text-align:right; }
    .checkout-wrap { max-width: 900px; margin: 20px auto; }
    .card { background:#fff; border:1px solid #eee; border-radius:12px; padding:16px; margin-bottom:16px; }
    .card h2 { margin-top:0; }
    .muted { color:#6b7280; font-size: 0.95rem; }
    .btn-primary { background:#111827; color:#fff; border:none; padding:12px 16px; border-radius:10px; cursor:pointer; }
    .btn-danger { background:#e11d48; color:#fff; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .btn { background:#f3f4f6; border:1px solid #e5e7eb; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .total-line { text-align:right; font-weight:700; font-size:1.1rem; }
    .juice-box { background:#fff7ed; border:1px solid #fed7aa; padding:12px; border-radius:10px; text-align:center; }
  </style>
</head>
<body>
<header>
  <nav class="navbar">
    <div class="logo">
      <a href="index.html"><span class="logo-mark">B‚Äôs</span> Beauty Blossom</a>
    </div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="perfume.html">Perfume</a></li>
      <li><a href="body.html">Body</a></li>
      <li><a href="skincare.html">Skincare</a></li>
      <li><a href="cosmetics.html">Cosmetics</a></li>
      <li><a href="jewellery.html">Jewellery</a></li>
      <li><a href="gift.html">Gift</a></li>
      <li><a href="cart.html" class="active">üõí Cart (<span id="cart-count">0</span>)</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
    <div class="hamburger" aria-label="menu" aria-expanded="false">&#9776;</div>
  </nav>
</header>

<main class="checkout-wrap">
  <h1>Checkout</h1>

  <section class="card">
    <h2>Your Cart</h2>
    <div id="cart-list" class="cart-list"></div>
    <div class="total-line"><span id="total">Total: Rs0</span></div>
  </section>

  <section class="card">
    <h2>Delivery Method</h2>
    <form id="delivery-form">
      <label><input type="radio" name="delivery" value="Pick Up" required> Pick Up (Free)</label><br>
      <label><input type="radio" name="delivery" value="Postage"> Postage (+Rs125)</label><br>
      <label><input type="radio" name="delivery" value="Delivery"> Delivery (+Rs150)</label><br><br>

      <div id="customer-info" style="display:none;">
        <h2>Customer Details</h2>
        <div class="row row-2" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <input type="text" id="name" placeholder="Full Name" required>
          <input type="email" id="email" placeholder="Email" required>
          <input type="tel" id="phone" placeholder="Phone (8 digits starting with 5)" required>
          <input type="text" id="address" placeholder="Delivery Address (for Delivery/Postage)">
        </div>

        <h2 style="margin-top:14px;">Payment Method</h2>
        <label><input type="radio" name="payment" value="Juice" required> Juice Payment (via account transfer)</label><br>
        <label><input type="radio" name="payment" value="Pick Up Payment"> Payment at Pick Up</label><br><br>

        <div id="juice-section" class="juice-box" style="display:none;">
          <h3 style="margin:6px 0 8px;">Juice Payment Instructions</h3>
          <p>1) Open your Juice app</p>
          <p>2) Transfer the total amount to <strong>Account: 000450702685</strong></p>
          <p>3) Send your payment screenshot to <strong>+230 58195560</strong></p>
          <p>4) Press ‚ÄúConfirm Order‚Äù once payment is completed</p>
        </div>

        <div style="margin-top:12px;">
          <button type="submit" class="btn-primary">Confirm Order</button>
        </div>
      </div>
    </form>
  </section>
</main>

<footer class="site-footer">
  <p>¬© 2025 B‚Äôs Beauty Blossom ‚Ä¢ All rights reserved</p>
</footer>

<script src="script.js" defer></script>

<script>
function getCart() { try { return JSON.parse(localStorage.getItem('cart')) || []; } catch { return []; } }
function setCart(c) { localStorage.setItem('cart', JSON.stringify(c)); }
function cartCount(c) { return c.reduce((s,i)=> s + Number(i.quantity||0), 0); }

let baseTotal = 0;
let extraCharge = 0;
function formatRs(n){ return 'Rs' + Number(n||0).toFixed(0); }

function renderCart() {
  const cart = getCart();
  const list = document.getElementById('cart-list');
  list.innerHTML = '';

  if (!cart.length) {
    list.innerHTML = '<p class="muted">Your cart is empty.</p>';
    document.getElementById('total').textContent = 'Total: Rs0';
    return;
  }

  cart.forEach((it, idx) => {
    const line = document.createElement('div');
    line.className = 'cart-item';
    const unit = Number(it.price || 0);
    const qty  = Math.max(1, Number(it.quantity || 1));
    const lineTotal = unit * qty;

    line.innerHTML = `
      <img class="cart-thumb" src="${it.imageURL || 'https://via.placeholder.com/100x100?text=Image'}" alt="">
      <div>
        <div class="cart-line">
          <b>${it.name}</b>
          <span class="muted">Unit: ${formatRs(unit)}</span>
        </div>
        <div class="qty-ctrl">
          <button class="minus" aria-label="decrease">‚àí</button>
          <input class="q" type="number" value="${qty}" min="1" step="1">
          <button class="plus" aria-label="increase">+</button>
          <button class="btn-danger remove" style="margin-left:8px;">Remove</button>
        </div>
      </div>
      <div class="line-total">${formatRs(lineTotal)}</div>
    `;

    const minus = line.querySelector('.minus');
    const plus  = line.querySelector('.plus');
    const qIn   = line.querySelector('.q');
    const rm    = line.querySelector('.remove');

    minus.onclick = () => { const c = getCart(); c[idx].quantity = Math.max(1, Number(c[idx].quantity||1) - 1); setCart(c); refresh(); };
    plus.onclick  = () => { const c = getCart(); c[idx].quantity = Math.max(1, Number(c[idx].quantity||1) + 1); setCart(c); refresh(); };
    qIn.onchange  = () => { const v = Math.max(1, Number(qIn.value || 1)); const c = getCart(); c[idx].quantity = v; setCart(c); refresh(); };
    rm.onclick    = () => { const c = getCart(); c.splice(idx, 1); setCart(c); refresh(); };

    list.appendChild(line);
  });

  recalcTotals();
}

function recalcTotals(){
  const cart = getCart();
  baseTotal = cart.reduce((sum, it) => sum + Number(it.price||0) * Number(it.quantity||1), 0);
  document.getElementById('total').textContent = 'Total: ' + formatRs(baseTotal + extraCharge);

  const badge = document.getElementById('cart-count');
  if (badge) badge.textContent = String(cartCount(cart));
}

function refresh(){ renderCart(); }

const deliveryForm     = document.getElementById('delivery-form');
const customerInfo     = document.getElementById('customer-info');
const addressInput     = document.getElementById('address');
const juiceSection     = document.getElementById('juice-section');

document.querySelectorAll('input[name="delivery"]').forEach(r => {
  r.addEventListener('change', () => {
    customerInfo.style.display = 'block';

    if (r.value === 'Postage') { extraCharge = 125; addressInput.required = true; }
    else if (r.value === 'Delivery') { extraCharge = 150; addressInput.required = true; }
    else { extraCharge = 0; addressInput.required = false; }

    recalcTotals();

    document.querySelectorAll('input[name="payment"]').forEach(p => {
      if (r.value !== 'Pick Up' && p.value === 'Pick Up Payment') { p.checked = false; p.disabled = true; }
      else { p.disabled = false; }
    });

    const checked = document.querySelector('input[name="payment"]:checked');
    juiceSection.style.display = (checked && checked.value === 'Juice') ? 'block' : 'none';
  });
});

document.querySelectorAll('input[name="payment"]').forEach(p => {
  p.addEventListener('change', () => {
    juiceSection.style.display = (p.value === 'Juice') ? 'block' : 'none';
  });
});

function validateForm(){
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const delivery = document.querySelector('input[name="delivery"]:checked')?.value;
  const payment  = document.querySelector('input[name="payment"]:checked')?.value;

  if(!/^5\d{7}$/.test(phone)){ alert("Phone must start with 5 and be 8 digits."); return false; }
  if(!email.includes("@")){ alert("Enter a valid email."); return false; }
  if ((delivery === "Postage" || delivery === "Delivery") && payment !== "Juice") {
    alert("For Postage/Delivery, payment must be Juice."); return false;
  }
  return true;
}

deliveryForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if(!validateForm()) return;

  const cart = getCart();
  if(!cart.length){ alert("Cart is empty."); return; }

  const delivery = document.querySelector('input[name="delivery"]:checked').value;
  const payment  = document.querySelector('input[name="payment"]:checked').value;

  const order = {
    items: cart.map(i => ({
      name: i.name,
      qty: Number(i.quantity||1),
      unitPrice: Number(i.price||0),
      imageURL: i.imageURL || null
    })),
    shipping: (delivery === 'Delivery') ? 150 : (delivery === 'Postage') ? 125 : 0,
    total: baseTotal + extraCharge,
    timestamp: new Date().toISOString(),
    name: document.getElementById("name").value.trim(),
    email: document.getElementById("email").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    address: document.getElementById("address").value.trim() || "N/A",
    delivery: delivery === 'Delivery' ? 'Delivery' : null,
    postage:  delivery === 'Postage'  ? 'Postage'  : null,
    pickup:   delivery === 'Pick Up'  ? 'Pick Up'  : null,
    payment
  };

  try {
    const ref = firebase.database().ref('orders').push();
    await ref.set(order);
    alert("Order confirmed! Thank you for shopping with B‚Äôs Beauty Blossom.");
    localStorage.removeItem("cart");
    window.location.href = "index.html";
  } catch (err) {
    console.error(err);
    alert("Could not confirm order: " + (err?.message || err));
  }
});

document.addEventListener('DOMContentLoaded', () => {
  const hamburger = document.querySelector('.hamburger');
  const nav = document.querySelector('.nav-links');
  if (hamburger && nav) {
    hamburger.addEventListener('click', () => {
      nav.classList.toggle('show');
      const expanded = nav.classList.contains('show');
      hamburger.setAttribute('aria-expanded', expanded ? 'true' : 'false');
    });
  }
  renderCart();
});
</script>
</body>
</html>
