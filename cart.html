<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Checkout - B's Beauty Blossom</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="firebase-config.js"></script>
</head>
<body>
<header>
  <nav class="navbar">
    <div class="logo"><a href="index.html"><span class="logo-mark">Bâ€™s</span> Beauty Blossom</a></div>
    <ul class="nav-links">
      <li><a href="index.html">Home</a></li>
      <li><a href="perfume.html">Perfume</a></li>
      <li><a href="body.html">Body</a></li>
      <li><a href="skincare.html">Skincare</a></li>
      <li><a href="cosmetics.html">Cosmetics</a></li>
      <li><a href="jewellery.html">Jewellery</a></li>
      <li><a href="gift.html">Gift</a></li>
      <li><a href="cart.html" class="active">ðŸ›’ Cart (<span id="cart-count">0</span>)</a></li>
      <li><a href="admin.html">Admin</a></li>
    </ul>
    <div class="hamburger" aria-label="menu" aria-expanded="false">&#9776;</div>
  </nav>
  <div id="nav-overlay"></div>
</header>

<section class="section">
  <h1>Checkout</h1>

  <div id="cart-items" class="cart-list"></div>
  <div class="totals">
    <div class="totals-row"><span>Subtotal</span><span id="subtotal">Rs0</span></div>
    <div class="totals-row"><span>Shipping</span><span id="shipping">Rs0</span></div>
    <div class="totals-row"><strong>Total</strong><strong id="total">Rs0</strong></div>
  </div>

  <h2 class="pad">Delivery Method</h2>
  <form id="delivery-form" class="card" style="margin-top:10px">
    <label><input type="radio" name="delivery" value="Pick Up" required> Pick Up (Free)</label><br>
    <label><input type="radio" name="delivery" value="Postage"> Postage (+Rs125)</label><br>
    <label><input type="radio" name="delivery" value="Delivery"> Delivery (+Rs150)</label><br><br>

    <div id="customer-info" style="display:none;">
      <h2 class="pad">Customer Details</h2>
      <input type="text" id="name" placeholder="Full Name" required><br>
      <input type="email" id="email" placeholder="Email" required><br>
      <input type="tel" id="phone" placeholder="Phone Number" required><br>
      <div id="address-section" style="display:none;">
        <input type="text" id="address" placeholder="Delivery Address"><br>
      </div>

      <h2 class="pad">Payment Method</h2>
      <label><input type="radio" name="payment" value="Juice" required> Juice Payment (via account transfer)</label><br>
      <label><input type="radio" name="payment" value="Pick Up Payment"> Payment at Pick Up</label><br><br>

      <div id="juice-section" style="display:none; text-align:center;" class="card">
        <h3>Juice Payment Instructions</h3>
        <p>1. Open your Juice app</p>
        <p>2. Transfer the total amount to:</p>
        <p><strong>Account Number: 000450702685</strong></p>
        <p>3. Send your payment receipt to <strong>+230 58195560</strong></p>
        <p>4. Press "Confirm Order" once payment is completed</p>
      </div>

      <button type="submit" class="btn btn-primary" id="confirm">Confirm Order</button>
      <p id="order-status" class="muted" style="margin-top:8px"></p>
    </div>
  </form>
</section>

<footer class="site-footer">
  <p>Â© 2025 Bâ€™s Beauty Blossom â€¢ All rights reserved</p>
</footer>

<script>
  // Navbar toggle
  (function(){
    const burger = document.querySelector('.hamburger');
    const links  = document.querySelector('.nav-links');
    const overlay= document.getElementById('nav-overlay');
    if(!burger) return;
    function close(){ links.classList.remove('show'); overlay.classList.remove('show'); burger.setAttribute('aria-expanded','false'); }
    burger.addEventListener('click', ()=>{
      const open = links.classList.toggle('show');
      overlay.classList.toggle('show', open);
      burger.setAttribute('aria-expanded', String(open));
    });
    overlay.addEventListener('click', close);
    window.addEventListener('resize', ()=>{ if(window.innerWidth>=1024) close(); });
  })();

  // --- Cart render ---
  let baseTotal = 0, extraCharge = 0;

  function getCart(){
    return JSON.parse(localStorage.getItem("cart")) || [];
  }
  function setCart(cart){
    localStorage.setItem("cart", JSON.stringify(cart));
  }
  function updateBadge(){
    const cart = getCart();
    const count = cart.reduce((s,i)=>s+(Number(i.qty || i.quantity || 1)||1),0);
    const b = document.getElementById('cart-count'); if(b) b.textContent = count;
  }
  function money(n){ return 'Rs'+Number(n||0).toFixed(0); }

  function loadCart() {
    const cart = getCart();
    const container = document.getElementById("cart-items");
    container.innerHTML = "";
    baseTotal = 0;

    if(cart.length===0){
      container.innerHTML = '<p class="muted">Your cart is empty.</p>';
      document.getElementById("subtotal").textContent = money(0);
      document.getElementById("total").textContent    = money(0);
      document.getElementById("shipping").textContent = money(0);
      return;
    }

    cart.forEach((item, index)=>{
      const line = Number(item.price||0) * Number(item.qty||item.quantity||1);
      baseTotal += line;
      container.insertAdjacentHTML('beforeend', `
        <div class="cart-row">
          <img class="cart-thumb" src="${item.imageURL||'https://via.placeholder.com/80'}" alt="">
          <div>
            <div class="cart-title">${item.name||'Item'}</div>
            <div class="cart-meta">${money(item.price)} Ã— ${item.qty||1}</div>
          </div>
          <div class="cart-actions">
            <button class="qty-btn" onclick="changeQty(${index},-1)">â€“</button>
            <span class="qty-val">${item.qty||1}</span>
            <button class="qty-btn" onclick="changeQty(${index},1)">+</button>
          </div>
          <div class="cart-line">${money(line)}</div>
          <button class="btn danger" onclick="removeItem(${index})">Remove</button>
        </div>
      `);
    });

    document.getElementById("subtotal").textContent = money(baseTotal);
    updateTotal();
    updateBadge();
  }

  window.removeItem = function(index){
    const cart = getCart();
    cart.splice(index,1);
    setCart(cart);
    loadCart();
  }
  window.changeQty = function(index, delta){
    const cart = getCart();
    const item = cart[index];
    const q = Math.max(1, Number(item.qty||1)+delta);
    item.qty = q;
    setCart(cart);
    loadCart();
  }

  function updateTotal(){
    document.getElementById("shipping").textContent = money(extraCharge);
    document.getElementById("total").textContent    = money(baseTotal+extraCharge);
  }

  // Delivery & Payment UI logic
  const deliveryRadios = document.querySelectorAll('input[name="delivery"]');
  const paymentRadios  = document.querySelectorAll('input[name="payment"]');
  const customerInfo   = document.getElementById("customer-info");
  const addressSection = document.getElementById("address-section");
  const juiceSection   = document.getElementById("juice-section");

  deliveryRadios.forEach(radio=>{
    radio.addEventListener("change",()=>{
      customerInfo.style.display="block";
      if(radio.value === "Postage"){ 
        extraCharge = 125; addressSection.style.display="block";
      } else if(radio.value === "Delivery"){ 
        extraCharge = 150; addressSection.style.display="block";
      } else { 
        extraCharge = 0;   addressSection.style.display="none";
      }
      updateTotal();
      paymentRadios.forEach(pay=>{
        if(radio.value !== "Pick Up"){
          pay.disabled = (pay.value === "Pick Up Payment");
          if(pay.value === "Juice") pay.checked = true;
        } else {
          pay.disabled = false;
        }
      });
      juiceSection.style.display = (document.querySelector('input[name="payment"]:checked')?.value === "Juice") ? "block" : "none";
    });
  });
  paymentRadios.forEach(radio=>{
    radio.addEventListener("change",()=>{ juiceSection.style.display = (radio.value === "Juice") ? "block" : "none"; });
  });

  function validateForm(){
    const phone = document.getElementById("phone").value.trim();
    const email = document.getElementById("email").value.trim();
    const delivery = document.querySelector('input[name="delivery"]:checked').value;
    if(!/^5\d{7}$/.test(phone)){ alert("Phone number must start with 5 and be exactly 8 digits."); return false; }
    if(!email.includes("@")){ alert("Please enter a valid email address."); return false; }
    if(delivery !== "Pick Up"){
      const payment = document.querySelector('input[name="payment"]:checked').value;
      if(payment !== "Juice"){ alert("For Postage and Delivery, payment must be made via Juice."); return false; }
    }
    return true;
  }

  // ---------- STOCK CHECK + DECREMENT (Firestore transaction) ----------
  async function verifyAndDecrementStock(cart){
    // Each cart item should have: id (product doc id), qty, price, sizeLabel (optional)
    return db.runTransaction(async (tx)=>{
      for(const item of cart){
        if(!item.id){ continue; } // legacy items without id -> skip stock check
        const ref = db.collection('products').doc(item.id);
        const snap = await tx.get(ref);
        if(!snap.exists) throw new Error(`Product not found: ${item.name||item.id}`);

        const p = snap.data();
        let sizes = Array.isArray(p.sizes) ? [...p.sizes] : [];
        const label = item.sizeLabel || (/\(([^)]+)\)$/.exec(item.name||'')?.[1]) || null; // detect "(100ml)" if needed
        const req = Number(item.qty||1);

        if(sizes.length){
          // match size by label
          const idx = sizes.findIndex(s => String(s.label||'').toLowerCase() === String(label||'').toLowerCase());
          if(idx === -1){
            // if size not found, treat as no stock tracking for this item
            continue;
          }
          const cur = typeof sizes[idx].stock === 'number' ? sizes[idx].stock : null;
          if(cur !== null){
            if(cur < req) throw new Error(`${p.name} (${sizes[idx].label}) has only ${cur} left`);
            sizes[idx] = {...sizes[idx], stock: cur - req};
            tx.update(ref, { sizes });
          }
        } else {
          // single stock
          const cur = typeof p.stock === 'number' ? p.stock : null;
          if(cur !== null){
            if(cur < req) throw new Error(`${p.name} has only ${cur} left`);
            tx.update(ref, { stock: cur - req });
          }
        }
      }
    });
  }

  // ---------- Submit order ----------
  document.getElementById("delivery-form").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const status = document.getElementById('order-status'); status.textContent = '';

    if(!validateForm()) return;

    const cart = getCart();
    if(cart.length===0){ alert("Cart is empty."); return; }

    const selectedDelivery = document.querySelector('input[name="delivery"]:checked').value;
    const order = {
      items: cart.map(i=>({
        id: i.id || null,
        name: i.name,
        quantity: Number(i.qty||1),
        price: Number(i.price||0),
        imageURL: i.imageURL || null
      })),
      delivery: selectedDelivery === "Delivery" ? "Delivery" : null,
      postage: selectedDelivery === "Postage" ? "Postage" : null,
      pickup: selectedDelivery === "Pick Up" ? "Pick Up" : null,
      shipping: extraCharge,
      payment: document.querySelector('input[name="payment"]:checked').value,
      name: document.getElementById("name").value.trim(),
      email: document.getElementById("email").value.trim(),
      phone: document.getElementById("phone").value.trim(),
      address: document.getElementById("address").value.trim() || "N/A",
      subtotal: baseTotal,
      total: baseTotal+extraCharge,
      timestamp: new Date().toISOString()
    };

    // Verify stock + decrement
    try{
      document.getElementById('confirm').disabled = true;
      status.textContent = 'Checking stockâ€¦';
      await verifyAndDecrementStock(cart);
    }catch(err){
      document.getElementById('confirm').disabled = false;
      alert("Stock error: " + err.message);
      return;
    }

    // Save order to Realtime DB
    try{
      status.textContent = 'Placing orderâ€¦';
      const newOrderRef = firebase.database().ref('orders').push();
      await newOrderRef.set(order);
      alert("Order confirmed! Thank you for shopping with B's Beauty Blossom.");

      localStorage.removeItem("cart");
      loadCart();
      updateBadge();
      window.location.href="index.html";
    }catch(err){
      alert("Error saving order: " + err.message);
      document.getElementById('confirm').disabled = false;
    }
  });

  // Init
  loadCart();
  updateBadge();
</script>
</body>
</html>
