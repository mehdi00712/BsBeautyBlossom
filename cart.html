<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Checkout - B's Beauty Blossom</title>
<link rel="stylesheet" href="style.css">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBSA9iP3kjdYZM0eXt_KOXAgPT_z74cGJ8",
  authDomain: "beauty-blossom-5247d.firebaseapp.com",
  databaseURL: "https://beauty-blossom-5247d-default-rtdb.firebaseio.com",
  projectId: "beauty-blossom-5247d",
  storageBucket: "beauty-blossom-5247d.firebasestorage.app",
  messagingSenderId: "916163644879",
  appId: "1:916163644879:web:2bf1f40e21b1abd73816ba",
  measurementId: "G-1QD13LXLRM"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const database = firebase.database();
</script>
</head>
<body>
<header>
<nav class="navbar">
  <div class="logo"><a href="index.html"><span class="logo-mark">Bâ€™s</span> Beauty Blossom</a></div>
  <ul class="nav-links">
    <li><a href="index.html">Home</a></li>
    <li><a href="perfume.html">Perfume</a></li>
    <li><a href="body.html">Body</a></li>
    <li><a href="jewellery.html">Jewellery</a></li>
    <li><a href="gift.html">Gift</a></li>
    <li><a href="skincare.html">Skincare</a></li>
    <li><a href="cosmetics.html">Cosmetics</a></li>
    <li><a class="active" href="cart.html">ðŸ›’ Cart (<span id="cart-count">0</span>)</a></li>
    <li><a href="admin.html">Admin</a></li>
  </ul>
  <div class="hamburger">&#9776;</div>
</nav>
</header>

<section class="cart">
  <h1>Checkout</h1>
  <div id="cart-items"></div>

  <div class="cart-summary">
    <div class="total-line"><span>Subtotal</span><span id="subtotal">Rs0</span></div>
    <div class="total-line"><span>Shipping</span><span id="shipping">Rs0</span></div>
    <div class="total-line"><span>Total</span><span id="total">Rs0</span></div>
  </div>

  <h2>Delivery Method</h2>
  <form id="delivery-form">
    <label><input type="radio" name="delivery" value="Pick Up" required> Pick Up (Free)</label><br>
    <label><input type="radio" name="delivery" value="Postage"> Postage (+Rs125)</label><br>
    <label><input type="radio" name="delivery" value="Delivery"> Delivery (+Rs150)</label><br><br>

    <div id="customer-info" style="display:none;">
      <h2>Customer Details</h2>
      <input type="text" id="name" placeholder="Full Name" required><br>
      <input type="email" id="email" placeholder="Email" required><br>
      <input type="tel" id="phone" placeholder="Phone Number (8 digits starting 5)" required><br>
      <div id="address-section" style="display:none;">
        <input type="text" id="address" placeholder="Delivery Address"><br>
      </div>

      <h2>Payment Method</h2>
      <label><input type="radio" name="payment" value="Juice" required> Juice Payment (via account transfer)</label><br>
      <label><input type="radio" name="payment" value="Pick Up Payment"> Payment at Pick Up</label><br><br>

      <div id="juice-section" style="display:none; text-align:center;">
        <h3>Juice Payment Instructions</h3>
        <p>1. Open your Juice app</p>
        <p>2. Transfer the total amount to the following account:</p>
        <p><strong>Account Number: 000450702685</strong></p>
        <p>3. Send your payment receipt/screenshot to <strong>+230 58195560</strong></p>
        <p>4. Press "Confirm Order" below once payment is completed</p>
      </div>

      <button type="submit" class="btn">Confirm Order</button>
    </div>
  </form>
</section>

<script src="script.js"></script>
<script>
const cartCountEl = document.getElementById('cart-count');
const itemsEl = document.getElementById('cart-items');
const subtotalEl = document.getElementById('subtotal');
const shippingEl = document.getElementById('shipping');
const totalEl = document.getElementById('total');

let baseSubtotal = 0;
let shipping = 0;

function getCart(){ return JSON.parse(localStorage.getItem('cart')) || []; }
function setCart(c){ localStorage.setItem('cart', JSON.stringify(c)); }

function updateCounts(){
  const c = getCart();
  cartCountEl.textContent = c.reduce((s,i)=> s + Number(i.qty||i.quantity||0), 0);
}

function renderCart(){
  const cart = getCart();
  itemsEl.innerHTML = '';
  baseSubtotal = 0;

  if (!cart.length){
    itemsEl.innerHTML = '<p>Your cart is empty.</p>';
    subtotalEl.textContent = 'Rs0'; shippingEl.textContent = 'Rs0'; totalEl.textContent = 'Rs0';
    updateCounts(); return;
  }

  cart.forEach((it, idx)=>{
    const unit = Number(it.unitPrice ?? it.price ?? 0);
    const qty  = Number(it.qty ?? it.quantity ?? 1);
    const line = unit * qty;
    baseSubtotal += line;

    const row = document.createElement('div');
    row.className = 'cart-item';
    row.innerHTML = `
      <div class="cart-item-line">
        <img src="${it.imageURL || 'https://via.placeholder.com/120'}" alt="">
        <div>
          <p><strong>${it.name || 'Item'}</strong></p>
          <p>Rs${unit} x ${qty} = Rs${line}</p>
        </div>
        <button class="btn danger" data-i="${idx}">Remove</button>
      </div>`;
    itemsEl.appendChild(row);
  });

  itemsEl.querySelectorAll('button[data-i]').forEach(b => b.onclick = ()=>{
    const i = Number(b.dataset.i);
    const c = getCart(); c.splice(i,1); setCart(c); renderCart();
  });

  subtotalEl.textContent = 'Rs' + baseSubtotal;
  totalEl.textContent = 'Rs' + (baseSubtotal + shipping);
  updateCounts();
}

renderCart();

// Delivery & payment behavior
const deliveryRadios = document.querySelectorAll('input[name="delivery"]');
const paymentRadios  = document.querySelectorAll('input[name="payment"]');
const customerInfo   = document.getElementById("customer-info");
const addressSection = document.getElementById("address-section");
const juiceSection   = document.getElementById("juice-section");

deliveryRadios.forEach(r=>{
  r.addEventListener('change', ()=>{
    customerInfo.style.display = 'block';
    if (r.value === 'Postage'){ shipping = 125; addressSection.style.display='block'; }
    else if (r.value === 'Delivery'){ shipping = 150; addressSection.style.display='block'; }
    else { shipping = 0; addressSection.style.display='none'; }
    shippingEl.textContent = 'Rs'+shipping;
    totalEl.textContent = 'Rs'+(baseSubtotal+shipping);

    paymentRadios.forEach(p=>{
      if (r.value !== 'Pick Up'){
        if (p.value === 'Pick Up Payment'){ p.disabled = true; p.checked = false; }
        if (p.value === 'Juice'){ p.disabled = false; p.checked = true; }
      } else {
        p.disabled = false;
      }
    });
    juiceSection.style.display = document.querySelector('input[name="payment"]:checked')?.value === 'Juice' ? 'block' : 'none';
  });
});
paymentRadios.forEach(p => p.addEventListener('change', ()=> { juiceSection.style.display = p.value === 'Juice' ? 'block' : 'none'; }));

function validateForm(){
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const delivery = document.querySelector('input[name="delivery"]:checked').value;

  if(!/^5\d{7}$/.test(phone)){ alert("Phone number must start with 5 and be exactly 8 digits."); return false; }
  if(!email.includes("@")){ alert("Please enter a valid email address."); return false; }
  if(delivery !== 'Pick Up'){
    const pay = document.querySelector('input[name="payment"]:checked')?.value;
    if (pay !== 'Juice'){ alert("For Postage and Delivery, payment must be Juice."); return false; }
  }
  return true;
}

document.getElementById("delivery-form").addEventListener("submit", e=>{
  e.preventDefault();
  if(!validateForm()) return;

  const cart = getCart();
  if (!cart.length){ alert('Cart is empty.'); return; }

  const delivery = document.querySelector('input[name="delivery"]:checked').value;
  const order = {
    items: cart.map(i=>({
      name: i.name,
      unitPrice: Number(i.unitPrice ?? i.price ?? 0),
      qty: Number(i.qty ?? i.quantity ?? 1),
      imageURL: i.imageURL || ''
    })),
    delivery: delivery === 'Delivery' ? 'Delivery' : null,
    postage:  delivery === 'Postage'  ? 'Postage'  : null,
    pickup:   delivery === 'Pick Up'  ? 'Pick Up'  : null,
    shipping: shipping,
    payment: document.querySelector('input[name="payment"]:checked').value,
    name: document.getElementById("name").value.trim(),
    email: document.getElementById("email").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    address: document.getElementById("address").value.trim() || "N/A",
    subtotal: baseSubtotal,
    total: baseSubtotal + shipping,
    timestamp: new Date().toISOString()
  };

  const ref = database.ref('orders').push();
  ref.set(order).then(()=>{
    alert("Order confirmed! Thank you for shopping with B's Beauty Blossom.");
    localStorage.removeItem('cart');
    renderCart();
    location.href = 'index.html';
  }).catch(err=> alert('Error saving order: '+err));
});
</script>
</body>
</html>
