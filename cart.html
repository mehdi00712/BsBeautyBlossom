<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Checkout - B's Beauty Blossom</title>
<link rel="stylesheet" href="style.css">

<!-- Minimal page-only styles for smaller thumbs -->
<style>
  .cart-list { display:flex; flex-direction:column; gap:10px; }
  .cart-row {
    display:grid; grid-template-columns:56px 1fr auto auto;
    gap:12px; align-items:center; padding:10px;
    border:1px solid var(--line); border-radius:12px; background:#fff;
  }
  .cart-thumb {
    width:56px; height:56px; object-fit:cover; border-radius:8px; border:1px solid var(--line);
  }
  .cart-title { font-weight:600; }
  .cart-meta { font-size:.9rem; color:var(--muted); }
  .cart-actions { display:flex; gap:8px; align-items:center; }
  .qty-btn { width:28px; height:28px; border-radius:8px; border:1px solid var(--line); background:#fff; cursor:pointer; }
  .qty-val { min-width:24px; text-align:center; font-weight:600; }
  .cart-line { font-weight:700; white-space:nowrap; }
  .totals { margin-top:10px; display:flex; flex-direction:column; gap:6px; }
  .totals-row { display:flex; justify-content:space-between; }
  .totals strong { font-size:1.05rem; }
  .hint { color:var(--muted); font-size:.9rem; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyBSA9iP3kjdYZM0eXt_KOXAgPT_z74cGJ8",
  authDomain: "beauty-blossom-5247d.firebaseapp.com",
  databaseURL: "https://beauty-blossom-5247d-default-rtdb.firebaseio.com",
  projectId: "beauty-blossom-5247d",
  storageBucket: "beauty-blossom-5247d.firebasestorage.app",
  messagingSenderId: "916163644879",
  appId: "1:916163644879:web:2bf1f40e21b1abd73816ba",
  measurementId: "G-1QD13LXLRM"
};
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
</script>
</head>
<body>
<header>
<nav class="navbar">
  <div class="logo"><a href="index.html"><span class="logo-mark">Bâ€™s</span> Beauty Blossom</a></div>
  <ul class="nav-links">
    <li><a href="index.html">Home</a></li>
    <li><a href="perfume.html">Perfume</a></li>
    <li><a href="body.html">Body</a></li>
    <li><a href="jewellery.html">Jewellery</a></li>
    <li><a href="gift.html">Gift</a></li>
    <li><a href="skincare.html">Skincare</a></li>
    <li><a href="cosmetics.html">Cosmetics</a></li>
    <li><a href="cart.html" class="active">ðŸ›’ Cart (<span id="cart-count">0</span>)</a></li>
    <li><a href="admin.html">Admin</a></li>
  </ul>
  <div class="hamburger">&#9776;</div>
</nav>
</header>

<section class="section">
  <h1>Checkout</h1>

  <div id="cart-items" class="cart-list"></div>

  <div class="card">
    <div class="totals">
      <div class="totals-row"><span>Subtotal</span><strong id="subtotal">Rs0</strong></div>
      <div class="totals-row"><span>Shipping</span><strong id="shipping">Rs0</strong></div>
      <div class="totals-row"><span>Total</span><strong id="total">Rs0</strong></div>
    </div>
  </div>

  <h2>Delivery Method</h2>
  <form id="delivery-form" class="card">
    <label><input type="radio" name="delivery" value="Pick Up" required> Pick Up (Free)</label><br>
    <label><input type="radio" name="delivery" value="Postage"> Postage (+Rs125)</label><br>
    <label><input type="radio" name="delivery" value="Delivery"> Delivery (+Rs150)</label><br>
    <p class="hint" style="margin-top:8px">Postage/Delivery require Juice payment.</p>

    <div id="customer-info" style="display:none; margin-top:12px;">
      <h2>Customer Details</h2>
      <div class="row-2">
        <input type="text" id="name" placeholder="Full Name" required>
        <input type="email" id="email" placeholder="Email" required>
      </div>
      <div class="row-2">
        <input type="tel" id="phone" placeholder="Phone Number (8 digits starting with 5)" required>
        <input type="text" id="address" placeholder="Delivery Address (required for Delivery/Postage)">
      </div>

      <h2>Payment Method</h2>
      <label><input type="radio" name="payment" value="Juice" required> Juice (bank transfer)</label><br>
      <label><input type="radio" name="payment" value="Pick Up Payment"> Pay at Pick Up</label><br>

      <div id="juice-section" class="card" style="display:none; text-align:center; margin-top:10px;">
        <h3>Juice Payment Instructions</h3>
        <p>1. Open your Juice app</p>
        <p>2. Transfer the total amount to: <strong>Account Number: 000450702685</strong></p>
        <p>3. Send your payment screenshot to <strong>+230 58195560</strong></p>
        <p>4. Press "Confirm Order" once payment is completed</p>
      </div>

      <button type="submit" class="btn btn-primary" style="margin-top:10px;">Confirm Order</button>
    </div>
  </form>
</section>

<footer class="site-footer">
  <p>Â© 2025 Bâ€™s Beauty Blossom â€¢ All rights reserved</p>
</footer>

<script>
// Navbar toggle (reuses classes from your global CSS)
const hamburger = document.querySelector(".hamburger");
const navLinks = document.querySelector(".nav-links");
const overlay = document.getElementById('nav-overlay');
if (hamburger) {
  hamburger.addEventListener("click", ()=>{
    const open = navLinks.classList.toggle("show");
    document.body.classList.toggle("nav-open", open);
    if (overlay) overlay.classList.toggle('show', open);
  });
}
if (overlay) overlay.addEventListener('click', ()=>{
  navLinks.classList.remove('show'); document.body.classList.remove('nav-open'); overlay.classList.remove('show');
});

// ---- Cart logic (small thumbs) ----
let baseTotal = 0;
let shipping = 0;

function money(n){ return "Rs"+Number(n||0).toFixed(0); }

function updTotals(){
  const subtotal = baseTotal;
  const total = subtotal + shipping;
  document.getElementById("subtotal").textContent = money(subtotal);
  document.getElementById("shipping").textContent = money(shipping);
  document.getElementById("total").textContent = money(total);
}

function saveCart(cart){
  localStorage.setItem("cart", JSON.stringify(cart));
  document.getElementById("cart-count").textContent = cart.reduce((s,i)=>s+(Number(i.qty ?? i.quantity ?? 1)||1),0);
}

function loadCart(){
  const cart = JSON.parse(localStorage.getItem("cart")||"[]");
  const container = document.getElementById("cart-items");
  container.innerHTML = "";
  baseTotal = 0;

  if(cart.length===0){
    container.innerHTML = '<p class="muted">Your cart is empty.</p>';
    updTotals();
    saveCart(cart);
    return;
  }

  cart.forEach((item, idx)=>{
    const name = item.name || '';
    const qty = Number(item.qty ?? item.quantity ?? 1) || 1;
    const price = Number(item.price ?? item.unitPrice ?? 0) || 0;
    const line = qty * price;
    baseTotal += line;

    const img = item.imageURL || item.img || 'https://via.placeholder.com/80x80?text=Img';
    const row = document.createElement('div');
    row.className = 'cart-row';
    row.innerHTML = `
      <img class="cart-thumb" src="${img}" alt="">
      <div>
        <div class="cart-title">${name}</div>
        <div class="cart-meta">${money(price)} each</div>
      </div>
      <div class="cart-actions">
        <button class="qty-btn" data-act="dec">â€“</button>
        <span class="qty-val">${qty}</span>
        <button class="qty-btn" data-act="inc">+</button>
      </div>
      <div class="cart-line">${money(line)}</div>
    `;
    // Qty handlers
    row.querySelectorAll('.qty-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const act = btn.getAttribute('data-act');
        let c = JSON.parse(localStorage.getItem('cart')||'[]');
        let it = c[idx];
        if (!it) return;
        let q = Number(it.qty ?? it.quantity ?? 1) || 1;
        if (act==='inc') q++;
        if (act==='dec') q = Math.max(1, q-1);
        it.qty = q; delete it.quantity;
        saveCart(c);
        loadCart();
      });
    });
    // Remove on image long-press? Keep it simple: click title to remove
    row.querySelector('.cart-title').addEventListener('dblclick', ()=>{
      let c = JSON.parse(localStorage.getItem('cart')||'[]');
      c.splice(idx,1); saveCart(c); loadCart();
    });

    container.appendChild(row);
  });

  updTotals();
  saveCart(cart);
}

loadCart();

// Delivery & Payment interlocks
const deliveryRadios = document.querySelectorAll('input[name="delivery"]');
const paymentRadios  = document.querySelectorAll('input[name="payment"]');
const customerInfo   = document.getElementById("customer-info");
const addressInput   = document.getElementById("address");
const juiceSection   = document.getElementById("juice-section");

deliveryRadios.forEach(radio=>{
  radio.addEventListener("change",()=>{
    customerInfo.style.display="block";
    if (radio.value === "Postage"){ shipping = 125; addressInput.required = true; }
    else if (radio.value === "Delivery"){ shipping = 150; addressInput.required = true; }
    else { shipping = 0; addressInput.required = false; }
    updTotals();

    // Restrict payment: postage/delivery => Juice only
    paymentRadios.forEach(pay=>{
      if (radio.value === "Postage" || radio.value === "Delivery"){
        pay.disabled = (pay.value === "Pick Up Payment");
        if (pay.value === "Juice") pay.checked = true;
      } else {
        pay.disabled = false;
      }
    });
    const selected = document.querySelector('input[name="payment"]:checked');
    juiceSection.style.display = selected && selected.value === "Juice" ? "block" : "none";
  });
});

paymentRadios.forEach(r=>{
  r.addEventListener("change",()=>{
    juiceSection.style.display = r.value === "Juice" ? "block" : "none";
  });
});

function validateForm(){
  const phone = document.getElementById("phone").value.trim();
  const email = document.getElementById("email").value.trim();
  const delivery = document.querySelector('input[name="delivery"]:checked')?.value;

  if(!/^5\d{7}$/.test(phone)){
    alert("Phone number must start with 5 and be exactly 8 digits.");
    return false;
  }
  if(!email.includes("@")){
    alert("Please enter a valid email address.");
    return false;
  }
  if(!delivery){
    alert("Please select a delivery method.");
    return false;
  }
  if ((delivery==="Postage" || delivery==="Delivery") && !document.querySelector('input[name="payment"]:checked') ){
    alert("Please select Juice as payment for Postage/Delivery.");
    return false;
  }
  if ((delivery==="Postage" || delivery==="Delivery") && !document.getElementById("address").value.trim()){
    alert("Please enter your address for Postage/Delivery.");
    return false;
  }
  return true;
}

document.getElementById("delivery-form").addEventListener("submit", (e)=>{
  e.preventDefault();
  if(!validateForm()) return;

  const cart = JSON.parse(localStorage.getItem("cart")||"[]");
  if(cart.length===0){ alert("Cart is empty."); return; }

  const selectedDelivery = document.querySelector('input[name="delivery"]:checked').value;
  // Build clean items for DB
  const items = cart.map(it=>{
    const qty = Number(it.qty ?? it.quantity ?? 1) || 1;
    const unitPrice = Number(it.price ?? it.unitPrice ?? 0) || 0;
    return {
      name: it.name || '',
      imageURL: it.imageURL || it.img || '',
      qty,
      unitPrice
    };
  });

  const order = {
    items,
    delivery: selectedDelivery === "Delivery" ? "Delivery" : null,
    postage:  selectedDelivery === "Postage"  ? "Postage"  : null,
    pickup:   selectedDelivery === "Pick Up"  ? "Pick Up"  : null,
    shipping: shipping,
    subtotal: baseTotal,
    total: baseTotal + shipping,
    payment: document.querySelector('input[name="payment"]:checked').value,
    name: document.getElementById("name").value.trim(),
    email: document.getElementById("email").value.trim(),
    phone: document.getElementById("phone").value.trim(),
    address: document.getElementById("address").value.trim() || "N/A",
    timestamp: new Date().toISOString()
  };

  database.ref('orders').push(order)
    .then(()=>{
      alert("Order confirmed! Thank you for shopping with B's Beauty Blossom.");
      localStorage.removeItem("cart");
      loadCart();
      document.getElementById("cart-count").textContent = 0;
      window.location.href = "index.html";
    })
    .catch(err=>alert("Error saving order: " + err));
});
</script>
</body>
</html>
